app-id: org.mixxx.Mixxx
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: mixxx
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --filesystem=xdg-music
  - --persist=.mixxx
  - --device=all
  - --metadata=X-DConf=migrate-path=/org/mixxx/Mixxx
  - --env=QT_QPA_PLATFORM=xcb
  - --env=LV2_PATH=/app/extensions/Plugins/lv2
  - --system-talk-name=org.freedesktop.UPower
  - --env=ALSA_CONFIG_PATH=
  # JACK support via pipewire
  - --filesystem=xdg-run/pipewire-0
  - --system-talk-name=org.freedesktop.RealtimeKit1

rename-desktop-file: mixxx.desktop
rename-appdata-file: mixxx.appdata.xml
add-extensions:
  org.freedesktop.LinuxAudio.Plugins:
     directory: extensions/Plugins
     version: '20.08'
     add-ld-path: lib
     merge-dirs: lv2
     subdirectories: true
     no-autodownload: true
cleanup:
  - /include
  - /share/man
  - '*.a'
  - '*.la'
  - /lib/pkgconfig
modules:
  - shared-modules/glu/glu-9.json
  - shared-modules/libmad/libmad.json
  - shared-modules/python2.7/python-2.7.json
  - shared-modules/gudev/gudev.json
  - shared-modules/linux-audio/jack2.json

  - name: protobuf
    config-opts:
      - --with-zlib
      - --with-pic
    sources:
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v3.17.3/protobuf-all-3.17.3.tar.gz
        sha256: 77ad26d3f65222fd96ccc18b055632b0bfedf295cb748b712a98ba1ac0b704b2
    cleanup:
      - /bin

  - name: scons
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --optimize=1
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/project/scons/scons/3.1.1/scons-3.1.1.tar.gz
        sha256: 4cea417fdd7499a36f407923d03b4b7000b0f9e8fd7b31b316b9ce7eba9143a5
    cleanup:
      - '*'

  - name: portaudio
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/PortAudio/portaudio/archive/refs/tags/v19.7.0.tar.gz
        sha256: 5af29ba58bbdbb7bbcefaaecc77ec8fc413f0db6f4c4e286c40c3e1b83174fa0

  - name: portmidi
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/mixxxdj/portmidi/archive/refs/tags/236.tar.gz
        sha256: 5db9bcb78c728eb81218e905faa5f02eab1f851b3ae5e5b13312755b9b0db943
    cleanup:
      - /bin

  - name: taglib
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DWITH_MP4=ON
      - -DWITH_ASF=ON
    sources:
      - type: archive
        url: https://taglib.org/releases/taglib-1.12.tar.gz
        sha256: 7fccd07669a523b07a15bd24c8da1bbb92206cb19e9366c3692af3d79253b703
    cleanup:
      - /bin

  - name: chromaprint
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_SHARED_LIBS=ON
    sources:
      - type: archive
        url: https://github.com/acoustid/chromaprint/releases/download/v1.5.0/chromaprint-1.5.0.tar.gz
        sha256: 573a5400e635b3823fc2394cfa7a217fbb46e8e50ecebd4a61991451a8af766a

  - name: rubberband
    buildsystem: meson
    sources:
      - type: archive
        url: https://breakfastquay.com/files/releases/rubberband-1.9.2.tar.bz2
        sha256: b3cff5968517141fcf9e1ef6b5a1fdb06a5511f148000609216cf182ff4ab612

  - libid3tag/libid3tag.json

  - name: libusb
    config-opts:
      - --disable-static
      - --disable-udev
    sources:
      - type: archive
        url: https://github.com/libusb/libusb/releases/download/v1.0.23/libusb-1.0.23.tar.bz2
        sha256: db11c06e958a82dac52cf3c65cb4dd2c3f339c8a988665110e0d24d19312ad8d

  - name: lilv
    buildsystem: simple
    build-commands:
      - python3 waf configure --prefix=${FLATPAK_DEST}
                              --default-lv2-path=${FLATPAK_DEST}/lib/lv2
                              --no-bash-completion
                              --no-utils
      - python3 waf build -j ${FLATPAK_BUILDER_N_JOBS}
      - python3 waf install
    sources:
      - type: archive
        url: 'https://download.drobilla.net/lilv-0.24.4.tar.bz2'
        sha256: c33b84b7a6e8e8fffb412fbcd6f69e59ca297ef3e29d829249b4ccc94f634438
    modules:
      - name: lv2
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=${FLATPAK_DEST}
                                  --lv2dir=${FLATPAK_DEST}/lib/lv2
                                  --no-plugins
          - python3 waf build -j ${FLATPAK_BUILDER_N_JOBS}
          - python3 waf install
        sources:
          - type: git
            url: 'https://github.com/drobilla/lv2.git'
            tag: v1.16.0
            commit: 0fa4d4847eb6d5bb0f58da889933c94c37ecb730
        cleanup:
          - /bin
          - /share/lv2specgen
      - name: serd
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=${FLATPAK_DEST} --no-utils
          - python3 waf build -j $FLATPAK_BUILDER_N_JOBS
          - python3 waf install
        sources:
          - type: archive
            url: 'https://download.drobilla.net/serd-0.30.0.tar.bz2'
            sha256: 6efb0efa5c2155e6bbac941cddeeabb7ed26d70a57d24178894ff169d8f6cefb

      - name: sord
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=${FLATPAK_DEST} --no-utils
          - python3 waf build -j $FLATPAK_BUILDER_N_JOBS
          - python3 waf install
        sources:
          - type: archive
            url: 'https://download.drobilla.net/sord-0.16.2.tar.bz2'
            sha256: 09f51174dd8f3efbd95f44f0bb0b165f08e066e052d40095de59de787987da8d

      - name: sratom
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=${FLATPAK_DEST}
          - python3 waf build -j $FLATPAK_BUILDER_N_JOBS
          - python3 waf install
        sources:
          - type: archive
            url: 'https://download.drobilla.net/sratom-0.6.2.tar.bz2'
            sha256: 0a514a55d6b6cb7b5d6f32d1dcb78a1e6e54537fa22fce533e4ef6adf240e853

  - name: upower
    config-opts: 
      - --disable-static
      - --with-pic
      - --with-systemdsystemunitdir=/app/lib/systemd/system
    sources:
      - type: archive
        url: https://upower.freedesktop.org/releases/upower-0.99.11.tar.xz
        sha256: 64b5ffbfccd5bdb15d925777979a4dbee1a957f9eaeb158dc76175267eddbdef

  # Use fdk-aac fork without HE-AAC to avoid patent issues
  # https://bugzilla.redhat.com/show_bug.cgi?id=1501522#c112
  - name: fdk-aac
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/wtaymans/fdk-aac-stripped.git
        commit: 585981a49f2186b0d2e47c64bf6b5abf539395f8
  
  - name: libmodplug
    config-opts:
      - --with-pic
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/project/modplug-xmms/libmodplug/0.8.8.5/libmodplug-0.8.8.5.tar.gz
        sha256: 77462d12ee99476c8645cb5511363e3906b88b33a6b54362b4dbc0f39aa2daad

  - name: mixxx
    buildsystem: simple
    build-commands:
      - scons prefix=${FLATPAK_DEST} -j ${FLATPAK_BUILDER_N_JOBS} build=release ffmpeg=1 faad=1
      - scons prefix=${FLATPAK_DEST} install
      - install -Dm644 ${FLATPAK_DEST}/share/pixmaps/mixxx_icon.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - icon_in="${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg";
        icon_out="${FLATPAK_ID}.png";
        for s in {32,64,128,256,512}; do
        rsvg-convert "${icon_in}" -w "${s}" -h "${s}" -a -f png -o "${icon_out}";
        install -p -Dm644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
        done;
    post-install:
      - desktop-file-edit --set-key="Exec" --set-value="mixxx %U" ${FLATPAK_DEST}/share/applications/mixxx.desktop
      - desktop-file-edit --set-key="Icon" --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/mixxx.desktop
      - install -d /app/extensions/Plugins
    sources:
      - type: archive
        url: https://github.com/mixxxdj/mixxx/archive/release-2.2.4.tar.gz
        sha256: 9372b43d5ec882845b4fe2350ef50dabb3f1e0cc029f182b0ed8aa4f4f3b2afa
      - type: patch
        path: patches/mixxx/appdata.patch
      - type: patch
        path: patches/mixxx/appdata-img.patch
      - type: patch
        path: patches/mixxx/gl.patch
