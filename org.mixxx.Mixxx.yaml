app-id: org.mixxx.Mixxx
runtime: org.kde.Platform
runtime-version: '5.15-21.08'
sdk: org.kde.Sdk
command: mixxx
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=x11
  # JACK support via PipeWire
  - --filesystem=xdg-run/pipewire-0
  # PulseAudio isn't actually helpful for Mixxx, but this allows access to ALSA
  # devices too since https://github.com/flatpak/flatpak/pull/3663
  - --socket=pulseaudio
  # Only used for MusicBrainz lookups
  - --share=network
  - --filesystem=xdg-music
  - --persist=.mixxx
  - --device=all
  - --metadata=X-DConf=migrate-path=/org/mixxx/Mixxx
  # Required due to use of legacy GLWidget which does not work with Wayland QPA
  - --env=QT_QPA_PLATFORM=xcb
  - --env=LV2_PATH=/app/extensions/Plugins/lv2
  # Required for battery widget
  - --system-talk-name=org.freedesktop.UPower
  - --env=ALSA_CONFIG_PATH=
  - --system-talk-name=org.freedesktop.RealtimeKit1

rename-icon: mixxx
add-extensions:
  org.freedesktop.LinuxAudio.Plugins:
     directory: extensions/Plugins
     version: '21.08'
     add-ld-path: lib
     merge-dirs: lv2
     subdirectories: true
     no-autodownload: true
cleanup:
  - /include
  - /share/man
  - '*.a'
  - '*.la'
  - /lib/pkgconfig
modules:
  - shared-modules/libmad/libmad.json
  - shared-modules/libusb/libusb.json
  - shared-modules/linux-audio/jack2.json
  - shared-modules/linux-audio/lv2.json
  - shared-modules/linux-audio/lilv.json
  # Required by upower
  - shared-modules/gudev/gudev.json
  # Required by qtkeychain
  - shared-modules/libsecret/libsecret.json

  - name: protobuf
    config-opts:
      - --with-zlib
      - --with-pic
    sources:
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v3.19.4/protobuf-cpp-3.19.4.tar.gz
        sha256: 89ac31a93832e204db6d73b1e80f39f142d5747b290f17340adce5be5b122f94
    cleanup:
      - /bin

  - name: portaudio
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/PortAudio/portaudio/archive/refs/tags/v19.7.0.tar.gz
        sha256: 5af29ba58bbdbb7bbcefaaecc77ec8fc413f0db6f4c4e286c40c3e1b83174fa0

  - name: portmidi
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/PortMidi/portmidi/archive/refs/tags/v2.0.2.tar.gz
        sha256: 60606c47a465d7d2b45b3c3016d52dba0d8d9d6ae3874e12f963182e36eb3244
    cleanup:
      - /bin

  - name: hidapi
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/libusb/hidapi/archive/refs/tags/hidapi-0.11.2.tar.gz
        sha256: bc4ac0f32a6b21ef96258a7554c116152e2272dacdec1e4620fc44abeea50c27

  - name: taglib
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DWITH_MP4=ON
      - -DWITH_ASF=ON
    sources:
      - type: archive
        url: https://taglib.org/releases/taglib-1.12.tar.gz
        sha256: 7fccd07669a523b07a15bd24c8da1bbb92206cb19e9366c3692af3d79253b703
    cleanup:
      - /bin

  - name: chromaprint
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_SHARED_LIBS=ON
    sources:
      - type: archive
        url: https://github.com/acoustid/chromaprint/releases/download/v1.5.0/chromaprint-1.5.0.tar.gz
        sha256: 573a5400e635b3823fc2394cfa7a217fbb46e8e50ecebd4a61991451a8af766a

  - name: rubberband
    buildsystem: meson
    sources:
      - type: archive
        url: https://breakfastquay.com/files/releases/rubberband-1.9.2.tar.bz2
        sha256: b3cff5968517141fcf9e1ef6b5a1fdb06a5511f148000609216cf182ff4ab612

  - name: soundtouch
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://codeberg.org/soundtouch/soundtouch/archive/2.3.1.tar.gz
        sha256: 42633774f372d8cb0a33333a0ea3b30f357c548626526ac9f6ce018c94042692

  - name: libid3tag
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/tenacityteam/libid3tag/archive/refs/tags/0.16.0.tar.gz
        sha256: ce60a545acf0f30cb96b5f298b74bb65caa513a56299e0435fc8f09dadc5e6ed

  - name: upower
    config-opts:
      - --disable-static
      - --with-pic
      - --with-systemdsystemunitdir=/app/lib/systemd/system
    sources:
      - type: archive
        url: https://upower.freedesktop.org/releases/upower-0.99.11.tar.xz
        sha256: 64b5ffbfccd5bdb15d925777979a4dbee1a957f9eaeb158dc76175267eddbdef

  # Use fdk-aac fork without HE-AAC to avoid patent issues
  # https://bugzilla.redhat.com/show_bug.cgi?id=1501522#c112
  - name: fdk-aac
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/wtaymans/fdk-aac-stripped.git
        commit: 585981a49f2186b0d2e47c64bf6b5abf539395f8

  - name: libmodplug
    config-opts:
      - --with-pic
    sources:
      - type: archive
        url: https://sourceforge.net/projects/modplug-xmms/files/libmodplug/0.8.9.0/libmodplug-0.8.9.0.tar.gz
        sha256: 457ca5a6c179656d66c01505c0d95fafaead4329b9dbaa0f997d00a3508ad9de

  - name: QtKeychain
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/frankosterfeld/qtkeychain/archive/refs/tags/v0.13.1.tar.gz
        sha256: dc84aea039b81f2613c7845d2ac88bad1cf3a06646ec8af0f7276372bb010c11

  - name: libebur128
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/jiixyj/libebur128/archive/refs/tags/v1.2.6.tar.gz
        sha256: baa7fc293a3d4651e244d8022ad03ab797ca3c2ad8442c43199afe8059faa613

  - name: libkeyfinder
    buildsystem: cmake-ninja
    # BUILD_TESTING=ON tries to download catch2 during the build step
    config-opts:
      - -DBUILD_TESTING=OFF
    sources:
      - type: archive
        url: https://github.com/mixxxdj/libkeyfinder/archive/refs/tags/v2.2.5.tar.gz
        sha256: 516570e310f5bb5d87146fbefb129eb972dab3347987783554001e2cac26d9d6

  - name: mixxx
    buildsystem: cmake-ninja
    # USE_SYMLINKS is only required for running the tests and fails with:
    #
    # [70/835] Symlinking test data to build directory...
    # FAILED: CMakeFiles/mixxx-testdata
    # cd /run/build/mixxx && /usr/bin/cmake -E create_symlink /run/build/mixxx/src/test /run/build/mixxx/src/test
    # failed to create symbolic link '/run/build/mixxx/src/test' because existing path cannot be removed: Is a directory
    #
    # Unfortunately there is no way for a Flatpak to install udev rule files, so that needs to be installed manually
    # by users who have HID or USB Bulk controllers.
    config-opts:
      - -DUSE_SYMLINKS=OFF
      - -DINSTALL_USER_UDEV_RULES=OFF
    post-install:
      - desktop-file-edit --set-key="Icon" --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/org.mixxx.Mixxx.desktop
      - desktop-file-edit --set-key="Exec" --set-value="mixxx %U" ${FLATPAK_DEST}/share/applications/org.mixxx.Mixxx.desktop
      - install -d /app/extensions/Plugins
    sources:
    - type: archive
      url: https://github.com/mixxxdj/mixxx/archive/refs/tags/2.3.1.tar.gz
      sha256: 35cff9acece5f651af472c11952ba59d5bc22e36225e6cb65c931afe0bc25b71
    - type: patch
      path: metainfo.patch
